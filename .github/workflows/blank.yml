# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
  pull_request:
    types:
      - opened
      - synchronize
        
    branches: [ "main", "master" ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This job provides signature verification of commits
  verify:
    # The type of runner that the job will run on
    runs-on: self-hosted

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Runs a set of commands using the runners shell
      - name: Install Git
        run: |
          apt-get update
          apt-get install software-properties-common
          add-apt-repository ppa:git-core/ppa
          apt-get update
          apt-get install git
          
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}

      # Runs a set of commands using the runners shell
      - name: Install required dependencies
        run: |
          apt-get install gnupg
          apt-get install curl
          apt-get install vim
          
      - name: Display the commit hash & branch that triggered this process
        run: echo "Triggering workflow for branch ${{ github.ref }} and commit-hash ${{ github.event.pull_request.head.sha }}"

      - name: Import the GPG public key of the committer
        env:
          GPG_PUBLIC_KEY: ${{ secrets.TEJH_GPG_PUBLIC_KEY }}
        run: |
          echo "$GPG_PUBLIC_KEY" > public_key.gpg
          gpg --import public_key.gpg
          gpg --list-keys
          
      - name: Show the current directory and .git folder
        run: |
          ls -ltr 
          ls .git
          
      - name: Verify the commit using the commiter's signature
        run: git verify-commit -v ${{ github.event.pull_request.head.sha }}

  # This job performs the actual task of Merging branches
  merge:
    # verify job needs to successfully complete before merge
    needs: verify

    # The type of runner that the job will run on
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v3

      - name: Merge Pull Request using rebasing
        run: |
          git config user.email "tejaswi.h@gmail.com"
          git config user.name "Tejaswi Haramurali"
          git fetch origin
          git checkout ${{ github.head_ref }}
          git rebase origin/main
          git checkout main
          git merge --ff-only ${{ github.head_ref }}
          git push origin main
      
          #uses: pullreminders/merge-action@v4
          #with:
          #merge_method: rebase
          #delete_branch: false
          #strict: true
      
